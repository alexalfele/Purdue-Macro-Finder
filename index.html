<!DOCTYPE html>
<html lang="en">
<head>import os
from datetime import datetime
from flask import Flask, request, jsonify
from flask_cors import CORS
from meal_finder_engine import MealFinder
import threading
import time 
import re 
import requests

# --- 1. SETUP THE FLASK APP ---
app = Flask(__name__)
CORS(app) 

# --- 2. KEEP-ALIVE CONFIGURATION ---
KEEP_ALIVE_URL = os.environ.get("RENDER_EXTERNAL_URL", "")  # Render sets this automatically
KEEP_ALIVE_INTERVAL = 840  # 14 minutes (Render free tier spins down after 15 min)

def keep_alive_ping():
    """Pings the server periodically to prevent spin-down"""
    while True:
        time.sleep(KEEP_ALIVE_INTERVAL)
        if KEEP_ALIVE_URL:
            try:
                requests.get(f"{KEEP_ALIVE_URL}/", timeout=10)
                print(f"[{datetime.now().strftime('%H:%M:%S')}] Keep-alive ping successful")
            except Exception as e:
                print(f"[{datetime.now().strftime('%H:%M:%S')}] Keep-alive ping failed: {e}")

# --- 3. LAZY INITIALIZATION SETUP ---
meal_finder_engine = None
engine_lock = threading.Lock()

def cleanup_old_caches():
    """Cleans up old cache files from previous days."""
    today_str = datetime.now().strftime('%Y-%m-%d')
    print(f"Cleaning caches, keeping files for: {today_str}")
    for filename in os.listdir('.'): 
        is_menu_cache = filename.startswith("menu_cache_")
        is_ai_cache = filename.startswith("ai_cache_")
        
        if (is_menu_cache or is_ai_cache) and today_str not in filename:
            try: 
                os.remove(filename)
                print(f"Removed old cache: {filename}")
            except OSError as e: 
                print(f"Error removing old cache file {filename}: {e}")

def get_engine():
    """Initializes and returns the MealFinder engine (thread-safe)."""
    global meal_finder_engine
    if meal_finder_engine:
        return meal_finder_engine
    
    with engine_lock:
        if meal_finder_engine:
            return meal_finder_engine
            
        print("FIRST REQUEST: Initializing MealFinder engine...")
        cleanup_old_caches()
        
        meal_finder_engine = MealFinder()
        
        print("FIRST REQUEST: Starting background data loaders...")
        meal_finder_engine.start_background_loaders()
        print("FIRST REQUEST: Initialization complete. Engine is live.")
        
        return meal_finder_engine

# --- 4. HEALTH CHECK ROUTE ---
@app.route("/")
def health_check():
    """A simple route to confirm the server is running."""
    return jsonify({"status": "healthy", "message": "Purdue Macro Finder API is running."})

# --- 5. API ENDPOINTS ---
@app.route("/api/find_meal", methods=["POST"])
def api_find_meal():
    engine = get_engine() 
    if not engine.data_loaded:
        return jsonify({"error": "Server is still loading menu data. Please try again in a moment."}), 503
    
    try:
        data = request.json
        targets = data.get('targets', {})
        meal_periods = data.get('meal_periods', []) 
        dietary_filters = data.get('dietary_filters', {})
        exclusion_list = data.get('exclusion_list', [])

        if not meal_periods:
            return jsonify({"error": "Please select at least one meal period."}), 400

        result = engine.find_best_meal(
            targets,
            meal_periods,
            exclusion_list,
            dietary_filters
        )
        
        if result is None:
            return jsonify({"error": "No meal plan found. Try adjusting your filters."}), 404

        return jsonify(result)
        
    except Exception as e:
        print(f"Error in /api/find_meal: {e}")
        return jsonify({"error": str(e)}), 500

@app.route("/api/suggest_meal", methods=["POST"])
def api_suggest_meal():
    engine = get_engine()
    if not engine.data_loaded:
        return jsonify({"error": "Server is still loading menu data. Please try again in a moment."}), 503

    try:
        data = request.json
        court = data.get('court')
        meal = data.get('meal')
        
        if not court or not meal:
            return jsonify({"error": "Court and meal period are required."}), 400
            
        suggestion = engine.get_ai_suggestion(court, meal)
        
        if isinstance(suggestion, dict) and suggestion.get("status") == "loading":
            return jsonify({"error": "AI suggestions are still being pre-loaded. Please try again in a moment."}), 503
            
        return jsonify(suggestion)
        
    except Exception as e:
        print(f"Error in /api/suggest_meal: {e}")
        return jsonify({"error": str(e)}), 500

# --- 6. START THE SERVER ---
if __name__ == "__main__":
    # Start keep-alive thread if URL is available
    if KEEP_ALIVE_URL:
        keep_alive_thread = threading.Thread(
            target=keep_alive_ping,
            daemon=True,
            name="KeepAlive"
        )
        keep_alive_thread.start()
        print(f"Keep-alive thread started (pinging every {KEEP_ALIVE_INTERVAL}s)")
    
    print("Starting Flask development server...")
    get_engine() 
    app.run(debug=False, port=int(os.environ.get("PORT", 5000)))
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Find the perfect meal at Purdue dining courts based on your macro targets">
    <title>Purdue Macro Finder</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <h1>Purdue Macro Finder</h1>
    </header>

    <div class="app-container">
        <!-- CONTROLS PANEL -->
        <div class="controls-panel">
            
            <!-- Tab Buttons -->
            <div class="tab-buttons" role="tablist" aria-label="Meal finding methods">
                <button class="tab-button active" data-tab="ai" role="tab" aria-selected="true" aria-controls="ai">
                    AI Suggestion
                </button>
                <button class="tab-button" data-tab="manual" role="tab" aria-selected="false" aria-controls="manual">
                    Manual Macros
                </button>
            </div>

            <!-- AI TAB -->
            <div id="ai" class="tab-content active" role="tabpanel" aria-labelledby="ai-tab">
                <form id="ai-form">
                    <div class="card">
                        <h2 class="form-header">Get an AI Meal</h2>
                        
                        <label for="ai-court">Dining Court</label>
                        <select id="ai-court" name="ai-court" aria-label="Select dining court">
                            <option value="Wiley">Wiley</option>
                            <option value="Earhart">Earhart</option>
                            <option value="Windsor">Windsor</option>
                            <option value="Ford">Ford</option>
                            <option value="Hillenbrand">Hillenbrand</option>
                        </select>
                        
                        <label for="ai-meal">Meal Period</label>
                        <select id="ai-meal" name="ai-meal" aria-label="Select meal period">
                            <option value="Breakfast">Breakfast</option>
                            <option value="Lunch" selected>Lunch</option>
                            <option value="Dinner">Dinner</option>
                        </select>
                    </div>
                </form>
            </div>

            <!-- MANUAL TAB -->
            <div id="manual" class="tab-content" role="tabpanel" aria-labelledby="manual-tab">
                <form id="manual-form">
                    
                    <!-- Target Macros -->
                    <details class="collapsible-card" open>
                        <summary>Target Macros</summary>
                        <div class="macro-grid">
                            <div>
                                <label for="target-protein">Protein (g)</label>
                                <input type="number" id="target-protein" value="40" min="0" max="500" aria-label="Target protein in grams">
                            </div>
                            <div>
                                <label for="target-carbs">Carbs (g)</label>
                                <input type="number" id="target-carbs" value="60" min="0" max="500" aria-label="Target carbs in grams">
                            </div>
                            <div>
                                <label for="target-fat">Fat (g)</label>
                                <input type="number" id="target-fat" value="20" min="0" max="500" aria-label="Target fat in grams">
                            </div>
                        </div>
                    </details>
                    
                    <!-- Dietary Filters -->
                    <details class="collapsible-card" open>
                        <summary>Dietary Filters</summary>
                        <div class="filters">
                            <label>
                                <input type="checkbox" data-filter="Vegetarian" aria-label="Vegetarian only">
                                Vegetarian
                            </label>
                            <label>
                                <input type="checkbox" data-filter="Vegan" aria-label="Vegan only">
                                Vegan
                            </label>
                            <label>
                                <input type="checkbox" data-filter="No Gluten" aria-label="No gluten">
                                No Gluten
                            </label>
                        </div>
                    </details>

                    <!-- Meal Periods -->
                    <details class="collapsible-card">
                        <summary>Meal Periods</summary>
                        <div class="filters">
                            <label>
                                <input type="checkbox" name="meal_period" value="Breakfast" aria-label="Include breakfast">
                                Breakfast
                            </label>
                            <label>
                                <input type="checkbox" name="meal_period" value="Lunch" checked aria-label="Include lunch">
                                Lunch
                            </label>
                            <label>
                                <input type="checkbox" name="meal_period" value="Dinner" checked aria-label="Include dinner">
                                Dinner
                            </label>
                            <label>
                                <input type="checkbox" name="meal_period" value="Late Lunch" aria-label="Include Late Lunch">
                                Late Lunch
                            </label>
                        </div>
                    </details>
                </form>
            </div>

            <!-- CTA Footer -->
            <div class="cta-footer">
                <button id="generate-button" class="cta-button" aria-label="Generate meal plan">
                    Generate My Meal Plan üçΩÔ∏è
                </button>
                <button id="reset-button" aria-label="Clear all inputs and results">
                    Clear
                </button>
                <p id="status-label" role="status" aria-live="polite">Select a tab and generate a meal.</p>
            </div>

        </div>

        <!-- RESULTS PANEL -->
        <div class="results-panel">
            
            <!-- Placeholder -->
            <div id="results-placeholder">
                <h3>Your Meal Awaits</h3>
                <p>Your meal recommendation will appear here.</p>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="hidden" role="status" aria-live="polite">
                <div class="spinner"></div>
                <p>Finding your meal...</p>
            </div>

            <!-- Results Content -->
            <div id="results-content" class="hidden">
                <h2 id="result-header">Your Meal Plan</h2>
                
                <!-- AI Explanation Card -->
                <div id="ai-explanation" class="card explanation-card hidden">
                    <h3>Why this meal?</h3>
                    <p id="ai-explanation-text"></p>
                </div>
                
                <!-- Macro Breakdown Chart -->
                <div class="card">
                    <h3>Macro Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="macro-chart" aria-label="Macro breakdown pie chart"></canvas>
                    </div>
                </div>

                <!-- Meal Items -->
                <div class="card">
                    <h3>Items</h3>
                    <div id="meal-plan-items" role="list">
                        <!-- Items will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
