<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Find the perfect meal at Purdue dining courts based on your macro targets">
    <title>Purdue Macro Finder</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 1. CSS VARIABLES & RESET --- */
        :root {
            --purdue-gold: #CFB991;
            --purdue-dark: #231F20;
            --bg-primary: #18181b;
            --bg-secondary: #27272a;
            --bg-tertiary: #3f3f46;
            --border-color: #5252b;
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --success: #22c55e;
            --warning: #fbbf24;
            --error: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 1.5rem;
            line-height: 1.6;
        }

        /* --- 2. HEADER --- */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--purdue-gold);
            margin: 0;
        }

        /* --- 3. LAYOUT --- */
        .app-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            max-width: 1200px;
            margin: auto;
        }

        @media (min-width: 1024px) {
            .app-container {
                grid-template-columns: 40% 1fr;
            }
        }

        .controls-panel, .results-panel {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .results-panel {
            min-height: 500px;
        }

        /* --- 4. TABS --- */
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .tab-button {
            flex: 1;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            padding: 1rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            color: var(--text-primary);
            background-color: rgba(207, 185, 145, 0.1);
        }

        .tab-button.active {
            color: var(--purdue-gold);
            border-bottom-color: var(--purdue-gold);
        }

        .tab-button:focus {
            outline: 2px solid var(--purdue-gold);
            outline-offset: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* --- 5. COLLAPSIBLE CARDS --- */
        .collapsible-card {
            background-color: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            transition: border-color 0.2s ease;
        }

        .collapsible-card:hover {
            border-color: var(--purdue-gold);
        }

        .collapsible-card summary {
            font-size: 1.125rem;
            font-weight: 600;
            padding: 1rem;
            cursor: pointer;
            list-style: none;
            user-select: none;
        }

        .collapsible-card summary::-webkit-details-marker {
            display: none;
        }

        .collapsible-card summary::before {
            content: '‚ñ∂';
            display: inline-block;
            margin-right: 0.5rem;
            transition: transform 0.2s ease;
        }

        .collapsible-card[open] summary::before {
            transform: rotate(90deg);
        }

        .collapsible-card[open] summary {
            border-bottom: 1px solid var(--border-color);
        }

        .collapsible-card > div {
            padding: 1rem;
        }

        /* --- 6. FORMS & INPUTS --- */
        .card {
            background-color: var(--bg-tertiary);
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .card h2, .card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            background-color: #52525b;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--purdue-gold);
            box-shadow: 0 0 0 3px rgba(207, 185, 145, 0.2);
        }

        input[type="number"]:hover,
        select:hover,
        textarea:hover {
            border-color: var(--purdue-gold);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .macro-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .filters label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            cursor: pointer;
            font-size: 1rem;
        }

        .filters label:hover {
            color: var(--purdue-gold);
        }

        input[type="checkbox"] {
            width: 1.25em;
            height: 1.25em;
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 4px;
            accent-color: var(--purdue-gold);
            cursor: pointer;
        }

        /* --- 7. BUTTONS --- */
        .cta-footer {
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .cta-button {
            width: 100%;
            padding: 1rem;
            background-color: var(--purdue-gold);
            color: var(--purdue-dark);
            border: none;
            border-radius: 6px;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cta-button:hover {
            background-color: #A68A56;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(207, 185, 145, 0.3);
        }

        .cta-button:active {
            transform: translateY(0);
        }

        .cta-button:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .cta-button:focus {
            outline: 2px solid var(--purdue-gold);
            outline-offset: 2px;
        }

        #reset-button {
            width: 100%;
            padding: 0.75rem;
            background-color: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.2s ease;
        }

        #reset-button:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--purdue-gold);
        }

        #status-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 1rem;
            min-height: 1.25em;
            transition: color 0.2s ease;
        }

        /* --- 8. LOADING STATES --- */
        .hidden {
            display: none !important;
        }

        #results-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 4rem 0;
        }

        #results-placeholder h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        #loading-spinner {
            text-align: center;
            padding: 4rem 0;
            color: var(--text-secondary);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid var(--border-color);
            border-bottom-color: var(--purdue-gold);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        .spinner-inline {
            width: 16px;
            height: 16px;
            border: 2px solid var(--purdue-dark);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 0.8s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- 9. RESULTS PANEL --- */
        #result-header {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--purdue-gold);
            margin-bottom: 1.5rem;
        }
        
        .card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
        }

        .explanation-card {
            background-color: #3f462a;
            border: 1px solid var(--purdue-gold);
        }

        .explanation-card h3 {
            color: var(--purdue-gold);
            border-bottom-color: var(--purdue-gold);
        }

        .explanation-card p {
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
        }

        /* --- 10. MEAL ITEMS --- */
        .item-card {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            background-color: var(--bg-secondary);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .item-card:hover {
            border-color: var(--purdue-gold);
            transform: translateX(4px);
        }

        .item-info h4 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
        }

        .item-info p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .item-macros {
            text-align: right;
            font-size: 0.875rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .item-macros span {
            display: block;
            font-weight: 500;
            margin: 0.125rem 0;
        }

        .item-macros .p {
            color: #6ee7b7;
        }

        .item-macros .c {
            color: #7dd3fc;
        }

        .item-macros .f {
            color: #fde047;
        }

        /* --- 11. CHART --- */
        .chart-container {
            position: relative;
            max-width: 300px;
            margin: auto;
        }

        /* --- 12. RESPONSIVE --- */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.75rem;
            }

            .macro-grid {
                grid-template-columns: 1fr;
            }

            .item-card {
                grid-template-columns: 1fr;
            }

            .item-macros {
                text-align: left;
                flex-direction: row;
                gap: 1rem;
            }
        }

        /* --- 13. ACCESSIBILITY --- */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        *:focus-visible {
            outline: 2px solid var(--purdue-gold);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Purdue Macro Finder</h1>
    </header>

    <div class="app-container">
        <div class="controls-panel">
            
            <div class="tab-buttons" role="tablist" aria-label="Meal finding methods">
                <button class="tab-button active" data-tab="ai" role="tab" aria-selected="true" aria-controls="ai">
                    AI Goal
                </button>
                <button class="tab-button" data-tab="manual" role="tab" aria-selected="false" aria-controls="manual">
                    Manual Macros
                </button>
            </div>

            <div id="ai" class="tab-content active" role="tabpanel" aria-labelledby="ai-tab">
                <form id="ai-form">
                    <div class="card">
                        <h2 class="form-header">Find a Meal by Goal</h2>
                        <label for="ai-goal">What's your goal for this meal?</label>
                        <textarea id="ai-goal" name="ai-goal" placeholder="e.g., 'High protein for muscle gain', 'Low carb meal', 'Pre-workout energy'"></textarea>
                    </div>
                </form>
            </div>

            <div id="manual" class="tab-content" role="tabpanel" aria-labelledby="manual-tab">
                <form id="manual-form">
                    
                    <details class="collapsible-card" open>
                        <summary>Target Macros</summary>
                        <div class="macro-grid">
                            <div>
                                <label for="target-protein">Protein (g)</label>
                                <input type="number" id="target-protein" value="40" min="0" max="500" aria-label="Target protein in grams">
                            </div>
                            <div>
                                <label for="target-carbs">Carbs (g)</label>
                                <input type="number" id="target-carbs" value="60" min="0" max="500" aria-label="Target carbs in grams">
                            </div>
                            <div>
                                <label for="target-fat">Fat (g)</label>
                                <input type="number" id="target-fat" value="20" min="0" max="500" aria-label="Target fat in grams">
                            </div>
                        </div>
                    </details>
                    
                    <details class="collapsible-card" open>
                        <summary>Dietary Filters</summary>
                        <div class="filters">
                            <label>
                                <input type="checkbox" data-filter="Vegetarian" aria-label="Vegetarian only">
                                Vegetarian
                            </label>
                            <label>
                                <input type="checkbox" data-filter="Vegan" aria-label="Vegan only">
                                Vegan
                            </label>
                            <label>
                                <input type="checkbox" data-filter="No Gluten" aria-label="No gluten">
                                No Gluten
                            </label>
                        </div>
                    </details>

                    <details class="collapsible-card">
                        <summary>Meal Periods</summary>
                        <div class="filters">
                            <label>
                                <input type="checkbox" name="meal_period" value="Breakfast" aria-label="Include breakfast">
                                Breakfast
                            </label>
                            <label>
                                <input type="checkbox" name="meal_period" value="Lunch" checked aria-label="Include lunch">
                                Lunch
                            </label>
                            <label>
                                <input type="checkbox" name="meal_period" value="Dinner" checked aria-label="Include dinner">
                                Dinner
                            </label>
                            <label>
                                <input type="checkbox" name="meal_period" value="Late Night" aria-label="Include late night">
                                Late Night
                            </label>
                        </div>
                    </details>
                </form>
            </div>

            <div class="cta-footer">
                <button id="generate-button" class="cta-button" aria-label="Generate meal plan">
                    Find My Meal üçΩÔ∏è
                </button>
                <button id="reset-button" aria-label="Clear all inputs and results">
                    Clear
                </button>
                <p id="status-label" role="status" aria-live="polite">Select a tab and generate a meal.</p>
            </div>

        </div>

        <div class="results-panel">
            
            <div id="results-placeholder">
                <h3>Your Meal Awaits</h3>
                <p>Your meal recommendation will appear here.</p>
            </div>

            <div id="loading-spinner" class="hidden" role="status" aria-live="polite">
                <div class="spinner"></div>
                <p>Finding your meal...</p>
            </div>

            <div id="results-content" class="hidden">
                <h2 id="result-header">Your Optimized Meal</h2>
                
                <div id="ai-explanation" class="card explanation-card hidden">
                    <h3>AI Goal Interpretation</h3>
                    <p id="ai-explanation-text"></p>
                </div>
                
                <div class="card">
                    <h3>Macro Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="macro-chart" aria-label="Macro breakdown pie chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>Items</h3>
                    <div id="meal-plan-items" role="list">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. CONFIGURATION ---
            const API_BASE_URL = "https://purdue-macro-finder.onrender.com";
            const RETRY_DELAY = 5000; // 5 seconds
            const MAX_RETRIES = 3;
            
            // --- 2. GET REFERENCES TO HTML ELEMENTS ---
            
            // Tabs
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Forms
            const aiForm = document.getElementById('ai-form');
            const manualForm = document.getElementById('manual-form');
            
            // AI Form Inputs (UPDATED)
            const aiGoal = document.getElementById('ai-goal');
            
            // Manual Form Inputs
            const targetProtein = document.getElementById('target-protein');
            const targetCarbs = document.getElementById('target-carbs');
            const targetFat = document.getElementById('target-fat');
            const filterCheckboxes = document.querySelectorAll('.filters input[data-filter]');
            const mealPeriodCheckboxes = document.querySelectorAll('input[name="meal_period"]');

            // Buttons & Status
            const generateButton = document.getElementById('generate-button');
            const resetButton = document.getElementById('reset-button');
            const statusLabel = document.getElementById('status-label');
            
            // Results Panel
            const resultsPlaceholder = document.getElementById('results-placeholder');
            const loadingSpinner = document.getElementById('loading-spinner');
            const resultsContent = document.getElementById('results-content');
            
            // Result Content Parts
            const resultHeader = document.getElementById('result-header');
            const aiExplanation = document.getElementById('ai-explanation');
            const aiExplanationText = document.getElementById('ai-explanation-text');
            const chartCanvas = document.getElementById('macro-chart').getContext('2d');
            const mealPlanItems = document.getElementById('meal-plan-items');
            
            // --- 3. GLOBAL STATE VARIABLES ---
            let activeTab = 'ai';
            let macroChart = null;
            let currentRetryTimeout = null;
            let retryCount = 0;

            // --- 4. UTILITY FUNCTIONS ---
            
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            function validateMacroInput(value, macroName) {
                const num = parseInt(value) || 0;
                if (num < 0) {
                    return { valid: false, message: `${macroName} cannot be negative` };
                }
                if (num > 500) {
                    return { valid: false, message: `${macroName} seems unreasonably high` };
                }
                return { valid: true };
            }

            // --- 5. INPUT VALIDATION ---
            
            const validateInputs = debounce(() => {
                if (activeTab === 'manual') {
                    const protein = parseInt(targetProtein.value) || 0;
                    const carbs = parseInt(targetCarbs.value) || 0;
                    const fat = parseInt(targetFat.value) || 0;
                    
                    if (protein > 100) {
                        statusLabel.textContent = '‚ö†Ô∏è High protein target';
                        statusLabel.style.color = '#fbbf24'; // yellow
                    } else if (protein === 0 && carbs === 0 && fat === 0) {
                        statusLabel.textContent = 'Set your macro targets';
                        statusLabel.style.color = '#a1a1aa'; // default
                    } else {
                        statusLabel.textContent = 'Ready to generate';
                        statusLabel.style.color = '#a1a1aa'; // default
                    }
                } else if (activeTab === 'ai') {
                    if (aiGoal.value.trim().length < 5) {
                        statusLabel.textContent = 'Describe your meal goal';
                        statusLabel.style.color = '#a1a1aa';
                    } else {
                        statusLabel.textContent = 'Ready to generate';
                        statusLabel.style.color = '#a1a1aa';
                    }
                }
            }, 500);
            
            targetProtein.addEventListener('input', validateInputs);
            targetCarbs.addEventListener('input', validateInputs);
            targetFat.addEventListener('input', validateInputs);
            aiGoal.addEventListener('input', validateInputs);

            // --- 6. EVENT LISTENERS ---

            // Tab switching
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    activeTab = button.dataset.tab;
                    setActiveTab(activeTab);
                    validateInputs(); // Update status label on tab switch
                });
            });

            // Main "Generate" button
            generateButton.addEventListener('click', () => {
                // Clear any pending retries
                if (currentRetryTimeout) {
                    clearTimeout(currentRetryTimeout);
                    currentRetryTimeout = null;
                }
                retryCount = 0;
                
                if (activeTab === 'ai') {
                    handleAiSuggestion();
                } else {
                    handleManualSearch();
                }
            });
            
            // Reset button
            resetButton.addEventListener('click', () => {
                aiForm.reset();
                manualForm.reset();
                
                // Re-check default meal periods
                mealPeriodCheckboxes.forEach(cb => {
                    cb.checked = (cb.value === 'Lunch' || cb.value === 'Dinner');
                });
                
                // Destroy chart if exists
                if (macroChart) {
                    macroChart.destroy();
                    macroChart = null;
                }
                
                showPlaceholder('Select a tab and generate a meal.');
                statusLabel.textContent = 'Cleared. Ready to go!';
                statusLabel.style.color = '#a1a1aa';
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !generateButton.disabled && 
                    (document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'INPUT')) {
                    generateButton.click();
                }
                if (e.key === 'Escape') {
                    resetButton.click();
                }
            });

            // --- 7. CORE API FUNCTIONS ---

            // UPDATED to send "goal" string
            async function handleAiSuggestion() {
                const goal = aiGoal.value.trim();
                if (goal.length < 5) {
                    showPlaceholder('Please describe your meal goal in a few words.');
                    return;
                }

                const payload = {
                    goal: goal,
                };
                
                showLoadingState('Asking AI to set targets...');
                
                try {
                    const result = await makeApiCall('/api/suggest_meal', payload);
                    displayResult(result, true); // We'll re-use the 'isAiResult' flag
                    retryCount = 0;
                } catch (error) {
                    handleApiError(error);
                }
            }

            async function handleManualSearch() {
                // Validate inputs
                const protein = parseInt(targetProtein.value) || 0;
                const carbs = parseInt(targetCarbs.value) || 0;
                const fat = parseInt(targetFat.value) || 0;
                
                const proteinValidation = validateMacroInput(protein, 'Protein');
                if (!proteinValidation.valid) {
                    showPlaceholder(proteinValidation.message);
                    return;
                }
                
                // Get selected meal periods
                const selectedMeals = [];
                mealPeriodCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        selectedMeals.push(cb.value);
                    }
                });
                
                if (selectedMeals.length === 0) {
                    showPlaceholder('Please select at least one meal period');
                    return;
                }

                // Get dietary filters
                const selectedFilters = {};
                filterCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        selectedFilters[cb.dataset.filter] = true;
                    }
                });

                const payload = {
                    targets: { p: protein, c: carbs, f: fat },
                    meal_periods: selectedMeals,
                    dietary_filters: selectedFilters,
                    exclusion_list: []
                };
                
                showLoadingState('Calculating the best meal plan...');

                try {
                    const result = await makeApiCall('/api/find_meal', payload);
                    displayResult(result, false);
                    retryCount = 0;
                } catch (error) {
                    handleApiError(error);
                }
            }
            
            async function makeApiCall(endpoint, payload) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: AbortSignal.timeout(30000) // 30 second timeout
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        if (response.status === 503) {
                            throw new Error('503:still_loading');
                        }
                        if (response.status === 429) {
                            throw new Error('429:rate_limit');
                        }
                        throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                    }
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    return data;
                    
                } catch (error) {
                    if (error.name === 'TimeoutError') {
                        throw new Error('Request timed out. Please try again.');
                    }
                    throw error;
                }
            }

            // --- 8. UI/DOM HELPER FUNCTIONS ---

            function setActiveTab(tabName) {
                tabButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === tabName);
                });
                
                const tabNameText = tabName === 'ai' ? 'AI Goal' : 'Manual Macros';
                statusLabel.textContent = `Switched to ${tabNameText} tab.`;
                statusLabel.style.color = '#a1a1aa';
            }

            function showLoadingState(message) {
                generateButton.disabled = true;
                generateButton.innerHTML = '<span class="spinner-inline"></span> Finding...';
                statusLabel.textContent = message;
                statusLabel.style.color = '#a1a1aa';
                
                resultsPlaceholder.classList.add('hidden');
                resultsContent.classList.add('hidden');
        
                loadingSpinner.classList.remove('hidden');
            }

            function showPlaceholder(message) {
                statusLabel.textContent = message;
                statusLabel.style.color = '#a1a1aa';
                resultsPlaceholder.classList.remove('hidden');
                resultsContent.classList.add('hidden');
                loadingSpinner.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.innerHTML = 'Find My Meal üçΩÔ∏è';
            }
            
            function handleApiError(error) {
                // Handle rate limiting
                if (error.message === '429:rate_limit') {
                    showPlaceholder('‚ö†Ô∏è Too many requests. Please wait a minute and try again.');
                    generateButton.disabled = true;
                    setTimeout(() => {
                        generateButton.disabled = false;
                    }, 60000); // Re-enable after 1 minute
                    return;
                }
                
                // Handle 503 retry logic
                if (error.message === '503:still_loading') {
                    if (retryCount < MAX_RETRIES) {
                        retryCount++;
                        statusLabel.textContent = `Server is waking up... Retry ${retryCount}/${MAX_RETRIES} in 5s`;
                        statusLabel.style.color = '#fbbf24'; // yellow
                        
                        currentRetryTimeout = setTimeout(() => {
                            generateButton.click();
                        }, RETRY_DELAY);
                        return;
                    } else {
                        showPlaceholder('Server is taking too long to respond. Please try again later.');
                        return;
                    }
                }
                
                // Show normal error
                showPlaceholder(`Error: ${error.message}`);
                statusLabel.style.color = '#ef4444'; // red
            }

            function displayResult(result, isAiResult) {
                statusLabel.textContent = `‚úÖ Found an optimized meal at ${result.court}!`;
                statusLabel.style.color = '#22c55e'; // green
                
                // 1. Set Header
                resultHeader.textContent = `Your Optimized Meal`;
                
                // 2. Show/Hide AI Explanation Card
                // We'll use the 'explanation' field from the AI *target* generation
                if (isAiResult && result.ai_explanation) {
                    aiExplanationText.textContent = result.ai_explanation;
                    aiExplanation.classList.remove('hidden');
                } else {
                    aiExplanation.classList.add('hidden');
                }
                
                // 3. Update Chart
                updateMacroChart(result.totals);
                
                // 4. Build Item Cards
                mealPlanItems.innerHTML = '';
                result.plan.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    
                    // Add animation
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(10px)';
                    
                    card.innerHTML = `
                        <div class="item-info">
                            <h4>${item.name}</h4>
                            <p>${item.serving_size || ''}</p>
                        </div>
                        <div class="item-macros">
                            <span class="p">P: ${(item.p || 0).toFixed(0)}g</span>
                            <span class="c">C: ${(item.c || 0).toFixed(0)}g</span>
                            <span class="f">F: ${(item.f || 0).toFixed(0)}g</span>
                        </div>
                    `;
                    
                    mealPlanItems.appendChild(card);
                    
                    // Trigger animation
                    setTimeout(() => {
                        card.style.transition = 'all 0.3s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 50);
                });

                // 5. Show results
                resultsPlaceholder.classList.add('hidden');
                loadingSpinner.classList.add('hidden');
                resultsContent.classList.remove('hidden');
                
                generateButton.disabled = false;
                generateButton.innerHTML = 'Find My Meal üçΩÔ∏è';
            }

            function updateMacroChart(totals) {
                const { p = 0, c = 0, f = 0 } = totals;
                const calories = [p * 4, c * 4, f * 9];
                const labels = [
                    `Protein (${p.toFixed(0)}g)`, 
                    `Carbs (${c.toFixed(0)}g)`, 
                    `Fat (${f.toFixed(0)}g)`
                ];

                // Destroy existing chart
                if (macroChart) {
                    macroChart.destroy();
                    macroChart = null;
                }

                macroChart = new Chart(chartCanvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: calories,
                            backgroundColor: ['#6ee7b7', '#7dd3fc', '#fde047'],
                            borderColor: '#3f3f46',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white',
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        let value = context.parsed;
                                        let total = context.chart.getDatasetMeta(0).total;
                                        let percentage = ((value / total)* 100).toFixed(0);
                                        return `${context.label}: ${percentage}% of calories`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- 9. INITIALIZE ---
            setActiveTab(activeTab);
            validateInputs(); // Run once on load
            
            // Add accessibility attributes
            generateButton.setAttribute('aria-label', 'Generate meal plan');
            loadingSpinner.setAttribute('role', 'status');
            loadingSpinner.setAttribute('aria-live', 'polite');

            console.log('Purdue Macro Finder initialized successfully!');
        });
    </script>
</body>
</html>
